<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CyberMatrix Chat v3.14</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="crt">
    <div class="cyber-frame">
        <div class="online-hud">
            <div>ACTIVE TERMINALS: <span id="onlineCount">0</span></div>
            <div>YOUR ID: <span id="currentUserId"></span></div>
        </div>

        <div class="chat-container" id="chatContainer"></div>

        <form id="chatForm" class="cyber-form">
            <input type="text" class="cyber-input" 
                   placeholder="ВВЕДИТЕ СООБЩЕНИЕ..." 
                   autocomplete="off"
                   id="messageInput">
            <button type="submit">➤</button>
        </form>
    </div>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { 
          getDatabase, ref, push, onValue, 
          set, onDisconnect, serverTimestamp 
        } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyBO3ZFs_PYZ7HubkuGkLu23EzyzpNlD5oc",
            authDomain: "anonchat-200d7.firebaseapp.com",
            databaseURL: "https://anonchat-200d7-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "anonchat-200d7",
            storageBucket: "anonchat-200d7.firebasestorage.app",
            messagingSenderId: "556527619851",
            appId: "1:556527619851:web:7e03d8882f789588719c0e",
            measurementId: "G-M8L540PND8"
        };

        class CyberChat {
            constructor() {
                this.app = initializeApp(firebaseConfig);
                this.db = getDatabase(this.app);
                this.auth = getAuth(this.app);
                this.userId = null;
                this.presenceRef = null;
                this.MESSAGE_DELAY = 2000;
                this.lastSentTime = 0;
                this.lastMessage = '';
                this.initAuth();
            }

            async initAuth() {
                try {
                    const userCredential = await signInAnonymously(this.auth);
                    this.userId = userCredential.user.uid;
                    document.getElementById('currentUserId').textContent = `user-${this.userId.substr(0, 8)}`;
                    this.initPresence();
                    this.initChat();
                } catch (error) {
                    console.error('Auth error:', error);
                }
            }

            async initPresence() {
                this.presenceRef = ref(this.db, `presence/${this.userId}`);
                await set(this.presenceRef, {
                    online: true,
                    lastActive: serverTimestamp()
                });

                onDisconnect(this.presenceRef).set({
                    online: false,
                    lastActive: serverTimestamp()
                });

                this.setupPresenceListener();
            }

            setupPresenceListener() {
                const presenceRef = ref(this.db, 'presence');
                onValue(presenceRef, (snapshot) => {
                    const users = snapshot.val() || {};
                    const onlineUsers = Object.values(users).filter(user => user.online);
                    document.getElementById('onlineCount').textContent = onlineUsers.length;
                });
            }

            async sendMessage(content) {
                const now = Date.now();
                const cleanContent = DOMPurify.sanitize(content.trim());
                
                if (!cleanContent || 
                    cleanContent.length > 500 ||
                    cleanContent === this.lastMessage ||
                    now - this.lastSentTime < this.MESSAGE_DELAY
                ) {
                    throw new Error('Сообщение слишком часто или повторяется');
                }

                // Дополнительная проверка на спам-паттерны
                if (this.isSpamPattern(cleanContent)) {
                    throw new Error('Обнаружен спам-паттерн');
                }

                try {
                    await push(ref(this.db, 'messages'), {
                        userId: this.userId,
                        content: cleanContent,
                        timestamp: serverTimestamp()
                    });
                    
                    this.lastMessage = cleanContent;
                    this.lastSentTime = now;
                } catch (error) {
                    console.error("Transmission error:", error);
                    throw error;
                }
            }

            isSpamPattern(content) {
                const spamRegex = /(\S)(\1{5,}|(?: ?\S\1{2,}){4})/g;
                return spamRegex.test(content);
            }

            initChat() {
                const form = document.getElementById('chatForm');
                const input = document.getElementById('messageInput');

                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    input.disabled = true;
                    
                    try {
                        await this.sendMessage(input.value);
                        input.value = '';
                    } catch (error) {
                        console.warn('Blocked:', error.message);
                        input.value = '[BLOCKED] ' + input.value;
                    }
                    
                    setTimeout(() => {
                        input.disabled = false;
                    }, this.MESSAGE_DELAY);
                });

                onValue(ref(this.db, 'messages'), (snapshot) => {
                    const messages = [];
                    snapshot.forEach(child => messages.push({ id: child.key, ...child.val() }));
                    this.renderMessages(messages);
                });
            }

            renderMessages(messages) {
                const container = document.getElementById('chatContainer');
                container.innerHTML = '';
                
                messages.forEach(msg => {
                    const msgDiv = document.createElement('div');
                    msgDiv.className = `message ${msg.userId === this.userId ? 'self' : ''}`;
                    
                    msgDiv.innerHTML = `
                        <div class="msg-header">
                            <span class="user-id">user-${msg.userId.substr(0, 8)}</span>
                            <span class="time">${new Date(msg.timestamp).toLocaleTimeString()}</span>
                        </div>
                        <div class="msg-content">${msg.content}</div>
                    `;
                    container.append(msgDiv);
                });
                
                container.scrollTop = container.scrollHeight;
            }
        }

        window.addEventListener('DOMContentLoaded', () => new CyberChat());
    </script>
</body>
</html>