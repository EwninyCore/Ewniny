<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CyberMatrix Chat v3.14</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="crt">
    <div class="cyber-frame">
        <div class="online-hud">
            <div>ACTIVE TERMINALS: <span id="onlineCount">0</span></div>
            <div>YOUR ID: <span id="currentUserId"></span></div>
        </div>

        <div class="chat-container" id="chatContainer"></div>

        <form id="chatForm" class="cyber-form">
            <input type="text" class="cyber-input" 
                   placeholder="ВВЕДИТЕ СООБЩЕНИЕ..." 
                   autocomplete="off"
                   id="messageInput">
            <button type="submit">➤</button>
        </form>
    </div>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js';
        import { 
            getDatabase, ref, push, onValue, 
            set, onDisconnect, serverTimestamp 
        } from 'https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBO3ZFs_PYZ7HubkuGkLu23EzyzpNlD5oc",
            authDomain: "anonchat-200d7.firebaseapp.com",
            databaseURL: "https://anonchat-200d7-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "anonchat-200d7",
            storageBucket: "anonchat-200d7.firebasestorage.app",
            messagingSenderId: "556527619851",
            appId: "1:556527619851:web:7e03d8882f789588719c0e",
            measurementId: "G-M8L540PND8"
        };
        class CyberChat {
            constructor() {
                this.app = initializeApp(firebaseConfig);
                this.db = getDatabase(this.app);
                this.userId = this.generateSecureId();
                this.presenceRef = ref(this.db, `presence/${this.userId}`);
                this.initPresence();
                this.initChat();
            }

            generateSecureId() {
                return 'user-' + crypto.getRandomValues(new Uint32Array(1))[0].toString(16);
            }

            async initPresence() {
                await set(this.presenceRef, {
                    online: true,
                    lastActive: serverTimestamp()
                });
                onDisconnect(this.presenceRef).remove();
 
                window.addEventListener('beforeunload', () => this.cleanupPresence());
                
                this.setupPresenceListener();
            }
            async cleanupPresence() {
                try {
                    await set(this.presenceRef, null);
                } catch (e) {
                    console.log("Connection already closed");
                }
            }

            setupPresenceListener() {
                onValue(ref(this.db, 'presence'), (snapshot) => {
                    const users = snapshot.val() || {};
                    document.getElementById('onlineCount').textContent = Object.keys(users).length;
                    document.getElementById('currentUserId').textContent = this.userId;
                });
            }

            async sendMessage(content) {
                const cleanContent = DOMPurify.sanitize(content);
                if (!cleanContent || cleanContent.length > 500) return;

                try {
                    await push(ref(this.db, 'messages'), {
                        userId: this.userId,
                        content: cleanContent,
                        timestamp: serverTimestamp()
                    });
                } catch (error) {
                    console.error("Transmission error:", error);
                }
            }

            initChat() {
                document.getElementById('chatForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const input = document.getElementById('messageInput');
                    input.disabled = true;
                    
                    try {
                        await this.sendMessage(input.value);
                        input.value = '';
                    } catch (error) {
                        console.error("Transmission failed:", error);
                        input.value = '[MESSAGE LOST] ' + input.value;
                    }
                    
                    input.disabled = false;
                });

                onValue(ref(this.db, 'messages'), (snapshot) => {
                    const messages = snapshot.val() ? Object.values(snapshot.val()) : [];
                    this.renderMessages(messages);
                });
            }

            renderMessages(messages) {
                const container = document.getElementById('chatContainer');
                container.innerHTML = messages.map(msg => `
                    <div class="message ${msg.userId === this.userId ? 'self' : ''}">
                        <div class="msg-header">
                            <span class="user-id">${msg.userId}</span>
                            <span class="time">${new Date(msg.timestamp).toLocaleTimeString()}</span>
                        </div>
                        <div class="msg-content">${msg.content}</div>
                    </div>
                `).join('');
                container.scrollTop = container.scrollHeight;
            }
        }

        window.addEventListener('DOMContentLoaded', () => new CyberChat());

    </script>
</body>
</html>